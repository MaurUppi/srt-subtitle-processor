# SRT字幕处理工具 - 任务分析报告

## 📊 数据结构分析

### source.txt 结构模式
```
序号
时间戳 (00:00:00,000 --> 00:00:00,000)
中文字幕行1
[中文字幕行2...]
英文字幕行1  
[英文字幕行2...]
空行
```

### expected.txt 结构模式
```
序号  ## 处理期望说明注释
时间戳
处理后的中文字幕
处理后的英文字幕
空行
```

## 🎯 处理期望规则提取

### 1. 对话格式处理
- **规则**: 在"-"后加入" "，提升格式美观性
- **示例**: "-怎么这么晚？" → "- 怎么这么晚？"
- **适用**: 所有语言的对话格式

### 2. 中文断行优化规则
- **字符限制**: 16字符基准
- **剩余字符判断**: 超出16字符但剩余<3个字符时不断行
- **断行位置**: 优先在"的、地、得"等助词前后断行
- **最小长度**: 确保断行后的行不少于5个字符（含标点）
- **标点补充**: 缺少句末标点时自动加入"。"

### 3. 英文断行优化规则
- **字符限制**: 42字符基准
- **剩余单词判断**: 超出42字符但剩余少于2个完整单词时不断行
- **单词完整性**: 保持单词完整，不在单词中间断行
- **语法优化**: 在适当的语法断点处理断行

### 4. SDH音效处理
- **合并规则**: 将多行相同的SDH标记合并为一行
- **示例**: "♪♪" + "♪♪" → "♪♪，♪♪"
- **标识**: 自动识别音效、音乐等SDH标记

## ❌ PRD与期望不一致分析

### 缺失的关键规则

1. **对话格式空格处理**
   - 当前PRD: 仅提及"对话处理"
   - 需补充: "-"后自动添加空格的具体规则

2. **中文智能断行阈值**
   - 当前PRD: "少于6个字符的行自动合并"
   - 需补充: 剩余字符<3个不断行，断行后≥5个字符

3. **英文单词数量判断**
   - 当前PRD: 未明确单词数量阈值
   - 需补充: 剩余<2个完整单词不断行

4. **SDH音效合并**
   - 当前PRD: 仅提及"SDH特殊处理"
   - 需补充: 多行相同SDH标记的合并规则

5. **标点符号自动补充**
   - 当前PRD: 未提及
   - 需补充: 缺少句末标点时的自动补充机制

## 📝 PRD修订建议

### 需要新增的处理规则

#### 对话格式优化
```
- 自动在"-"后添加空格（如果不存在）
- 统一对话格式为"- 内容"
- 保持多角色对话的分行结构
```

#### 中文智能断行阈值
```
- 超出16字符但剩余<3个字符时：不断行
- 断行时确保后续行≥5个字符（含标点）
- 在助词"的、地、得"等位置优化断行
- 自动补充缺失的句末标点"。"
```

#### 英文单词完整性
```
- 超出42字符但剩余<2个完整单词时：不断行
- 严格保持单词边界，避免词内断行
- 优化连词和介词的断行位置
```

#### SDH音效处理
```
- 识别重复的SDH标记（♪、[音效]等）
- 合并多行相同SDH为单行，用标点分隔
- 应用SDH专用的字符限制和速度规则
```

## ✅ 后续任务
- [ ] 更新 SRT_handler-PRD.md 文档为 SRT_handler-PRD-v2.md，补充缺失的处理规则
- [ ] 制定详细的测试用例覆盖所有边界情况
- [ ] 实现智能断行阈值判断逻辑
- [ ] 开发SDH音效自动合并功能