# SRT字幕断行处理工具  产品需求文档 (PRD) v2.0

一个功能强大的多语言字幕处理工具，支持中文、英文、韩语、日语字幕的智能断行和阅读速度控制，包含SDH（听障字幕）专业支持。

## 📋 命令行参数

| 参数 | 短参数 | 选项 | 说明 | 默认值 |
|------|--------|------|------|-------|
| `input_file` | - | - | 输入SRT文件路径 | - |
| `output_file` | - | - | 输出SRT文件路径（可选） | 自动生成 |
| `--batch` | `-b` | `[目录]` | 批处理模式 | 当前目录 |
| `--language` | `-l` | `auto/zh/en/ko/ja` | 指定语言 | `auto` |
| `--content-type` | `-c` | `adult/children` | 内容类型 | `adult` |
| `--sdh` | - | - | 启用SDH模式 | `False` |
| `--force-encoding` | `-e` | 编码格式 | 强制输出编码 | 自动检测 |
| `--no-speed-check` | - | - | 禁用阅读速度检查 | `false` |
| `--no-punct-fix` | - | - | 禁用标点符号自动补充 | `false` |

## 🌍 多语言支持

### 支持的语言

| 语言 | 代码 | 字符限制 | 阅读速度 (成人/儿童) | 特殊处理 |
|------|------|----------|---------------------|----------|
| 中文 | `zh` | 16字符 (SDH: 18) | 9/7 字符/秒 | 智能标点断行 + 助词优化 |
| 英文 | `en` | 42字符 | 20/17 字符/秒 | 单词边界断行 + 单词数阈值 |
| 韩语 | `ko` | 16字符 | 12/9 字符/秒 | 韩文字符计算 |
| 日语 | `ja` | 13字符 (SDH: 16) | 4/4 字符/秒 (SDH: 7/7) | 全角半角混合计算 |

### 自动语言检测

程序会自动分析字幕内容，根据字符特征判断语言类型：

- **中文检测**：汉字Unicode范围 (0x4e00-0x9fff) + 中文标点
- **英文检测**：ASCII字母字符
- **韩语检测**：韩文字符Unicode范围 (0xac00-0xd7af)
- **日语检测**：假名字符 (平假名 + 片假名) + 汉字组合

## 🎯 处理规则详解

### 通用格式处理

#### 对话格式优化
- **自动空格处理**：在"-"后自动添加空格（如果不存在）
- **统一格式**：所有对话格式统一为"- 内容"
- **多角色保持**：保持多角色对话的分行结构
- **示例**：`"-怎么这么晚？"` → `"- 怎么这么晚？"`

#### SDH音效处理
- **重复标记合并**：识别并合并多行相同的SDH标记
- **支持标记**：♪、[音效]、[音乐]、(音效)等
- **合并格式**：用逗号分隔，如 `"♪♪，♪♪"`
- **字符限制**：应用SDH专用的字符限制和速度规则

### 中文字幕处理

- **字符限制**：普通字幕16字符，SDH字幕18字符
- **智能断行阈值**：
  - 超出16字符但剩余<3个字符时：不断行
  - 断行时确保后续行≥5个字符（含标点）
- **助词优化断行**：优先在助词"的、地、得、了、吧、呢"等位置断行
- **语气停顿词**：的、了、吧、呢、啊、哦、嗯、呀、哇、吗、嘛
- **短行合并**：少于6个字符的行自动合并
- **标点补充**：缺少句末标点时自动添加"。"
- **对话处理**：特殊处理以 "-" 开头的对话格式

### 英文字幕处理

- **字符限制**：42字符（所有类型统一）
- **单词数阈值**：超出42字符但剩余少于2个完整单词时不断行
- **单词完整性**：绝不在单词中间断行，严格保持单词边界
- **语法优化**：在适当的语法断点（连词、介词前）处理断行
- **智能合并**：根据标点符号和语法结构智能合并多行
- **连词处理**：识别and、but、because、however等连词，优化断行位置
- **避免短行**：优化连词和介词的断行位置，避免过短的行

### 韩语字幕处理

- **字符限制**：16字符
- **智能合并**：`smart_merge_korean_lines()` 方法处理韩语标点
- **混合计算**：韩文字符1倍，ASCII字符0.5倍
- **标点处理**：支持韩语标点符号：'。！？，：""（）【】《》'
- **对话格式**：统一的"- "格式处理

### 日语字幕处理

- **字符限制**：普通13字符，SDH 16字符
- **智能合并**：`smart_merge_japanese_lines()` 方法处理日语标点
- **字符计算**：全角字符1倍，半角字符0.5倍
- **标点处理**：支持日语标点符号：'。！？、：""（）【】《》〈〉'
- **SDH特殊处理**：检测音效标记，应用SDH速度限制

## 🔧 算法实现要点

### 智能断行算法

#### 中文断行判断流程
```
1. 检查字符数是否超出限制（16字符）
2. 如果超出但剩余<3字符 → 不断行
3. 如果需要断行：
   - 查找助词位置（的、地、得等）
   - 确保断行后≥5字符
   - 无合适位置时在标点符号后断行
4. 检查是否缺少句末标点，自动补充
```

#### 英文断行判断流程
```
1. 检查字符数是否超出限制（42字符）
2. 如果超出：
   - 计算剩余部分的完整单词数
   - 如果剩余<2个完整单词 → 不断行
   - 否则在最近的单词边界断行
3. 优先在连词、介词前断行
```

### SDH处理算法
```
1. 识别连续的SDH标记行
2. 检查标记是否相同（♪♪、[音效]等）
3. 合并为单行，用逗号分隔
4. 应用SDH字符限制规则
```

## 📊 测试用例规范

### 边界情况测试
- 字符限制边界值测试（15/16/17字符中文，41/42/43字符英文）
- 剩余字符阈值测试（1/2/3字符剩余）
- 单词数阈值测试（1/2/3单词剩余）
- 对话格式处理测试（有无空格、多种符号）
- SDH标记合并测试（相同/不同标记）
- 标点符号补充测试（有无句末标点）

### 多语言混合测试
- 中英双语字幕处理
- 对话格式一致性
- 字符计算准确性
- 断行位置优化

## 🎯 版本更新说明

### v2.0 新增功能
1. **对话格式自动优化**："-"后自动添加空格
2. **智能断行阈值**：基于剩余字符/单词数的智能判断
3. **助词位置优化**：中文断行优先考虑助词位置
4. **SDH音效合并**：自动合并重复的SDH标记
5. **标点自动补充**：缺失句末标点时自动添加
6. **单词数阈值**：英文断行考虑剩余单词数量

### 兼容性
- 完全向后兼容v1.0规则
- 新增功能可通过参数禁用
- 保持Netflix官方标准一致性