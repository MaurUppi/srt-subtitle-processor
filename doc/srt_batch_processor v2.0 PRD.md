# SRT 字幕断行处理工具 v2.0 产品需求文档 (PRD)

## 1. 版本概述

### 1.1 版本信息
- **当前版本**: v1.7
- **目标版本**: v2.0
- **更新类型**: 重大功能升级

### 1.2 升级目标
- 扩展语言支持：新增韩语和日语字幕处理
- 优化现有中英文处理规则，符合国际标准
- 增加阅读速度控制功能
- 支持SDH（听障字幕）格式识别和处理
- 字符识别：正确识别输入文件的字符语言

## 2. 核心功能变更

### 2.1 语言支持扩展
- **现有**: 中文、英文
- **新增**: 韩语、日语
- **总计**: 四种语言全面支持

### 2.2 字幕类型识别
- **新增功能**: 自动识别普通字幕和SDH字幕
- **识别方法**: 检测音效描述标记（如 [音效]、(SOUND EFFECT)）

### 2.3 阅读速度控制
- **新增功能**: 根据字幕显示时长计算并优化阅读速度
- **差异化处理**: 成人内容和儿童内容采用不同标准

## 3. 处理规则更新

### 3.1 中文字幕处理规则

#### 行长限制
- 普通字幕：每行最多**16个字符**（修改自18个）
- SDH字幕：每行最多**18个字符**（新增）
- 每条字幕最多2行

#### 字符计算
- 所有中文字符、标点符号均计为1个字符
- 使用半角数字(1,2,3)而非全角(１,２,３)以优化字符数（新增）

#### 阅读速度（新增）
- 成人内容：最高9字符/秒
- 儿童内容：最高7字符/秒

#### 短行合并
- 少于6个字符的行自动合并到前一行
- 合并后不得超过行长限制

#### 断行规则
- 优先在标点符号后断行
- 在语义完整点断行，保持词组完整性
- 采用金字塔布局（下行较长）

#### 标点处理
- 标点符号不应出现在行首
- 保留原文标点，不做替换

### 3.2 英文字幕处理规则

#### 行长限制
- 所有类型：每行最多42个字符（保持不变）
- 每条字幕最多2行

#### 字符计算
- 所有字符（字母、空格、标点）均计为1个字符

#### 阅读速度（新增）
- 成人内容：最高20字符/秒
- 儿童内容：最高17字符/秒

#### 短行合并
- 基于语义完整性判断，**移除5个单词的硬性限制**（修改）
- 优先保持单行显示

#### 断行规则（优化）
- 永不在单词中间断行
- 优先在标点符号后断行
- 在连词前断行 (and, but, or, so)
- 在介词前断行 (in, on, at, to, for)
- 避免分离：冠词与名词、动词与主语代词、名与姓

#### 标点处理
- 保留所有原始标点
- 标点符号跟随其前面的单词

### 3.3 韩语字幕处理规则（新增）

#### 行长限制
- 所有类型：每行最多16个字符
- 每条字幕最多2行

#### 字符计算
- 韩文字符：1个字符
- 拉丁字母、空格、标点：0.5个字符

#### 阅读速度
- 成人内容：最高12字符/秒
- 儿童内容：最高9字符/秒

#### 短行合并
- 基于语义判断，避免过短的单独行
- 合并后需重新计算字符数

#### 断行规则
- 当一行有3个或以上标点符号时可断行
- 引用句子时可断行
- 保持语义单元完整

#### 标点处理
- 句号和逗号不应出现在行尾
- 逗号用于分隔同一字幕内的多个句子
- 保留原文标点符号

### 3.4 日语字幕处理规则（新增）

#### 行长限制
- 横排字幕：每行最多13个全角字符
- 竖排字幕：每行最多11个全角字符
- SDH横排：每行最多16个全角字符
- 普通字幕最多2行，SDH必要时可用3行

#### 字符计算
- 全角字符（汉字、假名、全角符号）：1个字符
- 半角字符（数字、英文、半角符号）：0.5个字符

#### 阅读速度
- 普通字幕：最高4字符/秒
- SDH字幕：最高7字符/秒

#### 短行合并
- 基于语义和节奏判断
- 避免单独的短句或片段

#### 断行规则
- 保持语义单元完整
- 避免在助词（は、が、を、に等）处断行
- 避免分离动词与其宾语
- 横排采用金字塔布局

#### 标点处理
- 句号（。）替换为全角空格
- 逗号（、）替换为半角空格
- 使用两字长破折号（⸺）表示跨字幕的句子延续
- 每个句子最多使用2个破折号

## 4. 技术实现要求

### 4.1 语言检测
- 自动检测每条字幕的语言类型
- 支持混合语言字幕的分别处理
- 增加语言检测准确性

### 4.2 字符计算优化
- 实现精确的字符宽度计算（全角/半角）
- 韩语混合字符的正确计算
- 日语竖排/横排的自动识别

### 4.3 阅读速度计算
```python
def calculate_reading_speed(text, duration, language, content_type='adult'):
    """
    计算阅读速度并判断是否需要调整
    
    参数:
    - text: 字幕文本
    - duration: 显示时长（秒）
    - language: 语言类型
    - content_type: 内容类型（'adult' 或 'children'）
    
    返回:
    - is_valid: 是否符合阅读速度要求
    - actual_speed: 实际阅读速度
    - max_speed: 允许的最大速度
    """
```

### 4.4 命令行参数扩展
```bash
# 新增参数
--language [auto|zh|en|ko|ja]  # 指定语言（默认auto）
--content-type [adult|children] # 内容类型（默认adult）
--sdh                          # 强制使用SDH规则
--no-speed-check              # 禁用阅读速度检查
```

## 5. 向后兼容性

### 5.1 保持兼容的功能
- 原有的命令行接口保持不变
- 批处理模式继续支持
- 文件命名规则不变

### 5.2 默认行为
- 未指定语言时自动检测
- 中文默认使用16字符限制（普通字幕）
- 英文保持42字符限制

## 6. 测试要求

### 6.1 单元测试
- 每种语言的字符计算准确性
- 断行规则的正确性
- 阅读速度计算的准确性

### 6.2 集成测试
- 四种语言的完整处理流程
- 混合语言字幕的处理
- SDH字幕的识别和处理

### 6.3 性能测试
- 大文件处理性能
- 批处理模式效率
- 内存使用优化

## 7. 文档更新

### 7.1 README更新
- 更新处理规则说明
- 添加新语言的使用示例
- 更新命令行参数说明

### 7.2 示例文件
- 提供四种语言的示例字幕文件
- 展示处理前后的对比效果

## 8. 发布计划

### 8.1 开发阶段
1. **阶段1**（2周）：实现韩语和日语基础支持
2. **阶段2**（1周）：添加阅读速度控制
3. **阶段3**（1周）：优化语言检测和SDH支持
4. **阶段4**（1周）：测试和文档更新

### 8.2 发布策略
- Beta版本：v2.0-beta（内部测试）
- 正式版本：v2.0（公开发布）

## 9. 风险评估

### 9.1 技术风险
- 日语竖排检测可能需要额外的字体信息
- 混合语言的准确识别存在挑战

### 9.2 用户影响
- 中文字符限制从18降至16可能影响现有用户
- 需要提供清晰的迁移指南

## 10. 成功指标

- 四种语言的处理准确率 > 95%
- 阅读速度符合标准的比例 > 90%
- 处理性能提升 > 20%
- 用户满意度维持或提升